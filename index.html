<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WPS-WEB 本地加速版</title>

<link href="./tabulator_modern.min.css" rel="stylesheet">
<script src="./tabulator.min.js"></script>
<script src="./xlsx.full.min.js"></script>
<script src="./papaparse.min.js"></script>

<style>
:root {
    --primary-color:#d32f2f;
    --vip-gold:#ffc107;
    --bg:#f0f2f5;
    --border:#e0e0e0;
}

html,body{
    height:100%;margin:0;
    font-family:system-ui,"Segoe UI";
    background:var(--bg);
    overflow:hidden;
}

.app-header{
    height:50px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:0 15px;
    background:#fff;
    border-bottom:1px solid var(--border);
}

.logo{font-weight:700;color:var(--primary-color);}

.btn{
    padding:6px 14px;
    font-size:13px;
    border:1px solid var(--border);
    border-radius:4px;
    background:#fff;
    cursor:pointer;
}

.btn-primary{
    background:var(--primary-color);
    color:#fff;
    border:none;
}

.btn-vip{
    background:var(--vip-gold);
    border:none;
    font-weight:700;
}

#table-wrapper{
    height:calc(100vh - 70px);
    margin:10px auto;
    width:96%;
    background:#fff;
    border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
    overflow:hidden;
}

.vip-panel{
    position:fixed;
    right:-300px;
    top:0;bottom:0;
    width:280px;
    padding:30px 20px;
    background:rgba(255,255,255,.75);
    backdrop-filter:blur(15px);
    transition:.35s;
    z-index:2000;
}

.vip-panel.active{right:0}

.toast{
    position:fixed;
    bottom:30px;
    left:50%;
    transform:translateX(-50%);
    background:#323232;
    color:#fff;
    padding:10px 18px;
    border-radius:20px;
    font-size:13px;
    opacity:0;
    animation:fade 2.5s forwards;
}

@keyframes fade{
    0%{opacity:0;transform:translate(-50%,10px)}
    10%{opacity:1}
    90%{opacity:1}
    100%{opacity:0}
}
</style>
</head>

<body>

<div class="app-header">
    <div>
        <span class="logo">WPS LITE</span>
        <button class="btn btn-primary" id="importBtn">导入</button>
        <button class="btn" id="addRowBtn">➕ 行</button>
        <button class="btn" id="addColBtn">➕ 列</button>
        <button class="btn" id="exportBtn">导出</button>
    </div>
    <button class="btn btn-vip" id="vipBtn">VIP 工具箱</button>
</div>

<input type="file" id="fileInput" hidden accept=".xlsx,.xls,.csv">

<div class="vip-panel" id="vipPanel">
    <h3>VIP 尊享</h3>
    <button class="btn" style="width:100%" id="themeBtn">一键美化</button>
    <button class="btn" style="width:100%;margin-top:10px" id="cleanBtn">清理空格</button>
    <input id="searchInput" placeholder="全表搜索…" style="width:100%;margin-top:15px;padding:8px">
    <button class="btn btn-primary" style="width:100%;margin-top:30px" id="closeVip">关闭</button>
</div>

<div id="table-wrapper">
    <div id="table"></div>
</div>

<script>
(() => {
let table;

const toast = msg => {
    const t = document.createElement('div');
    t.className='toast';
    t.innerText=msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),2500);
};

const initTable = (data=[],columns=null)=>{
    if(table) table.destroy();
    table = new Tabulator("#table",{
        data,
        columns,
        layout:"fitColumns",
        height:"100%",
        movableColumns:true,
        pagination:"local",
        paginationSize:50,
        autoColumns:!columns,
        autoColumnsDefinitions:defs=>{
            defs.forEach(d=>{
                d.editor="input";
                d.headerFilter="input";
                d.minWidth=80;
            });
            return defs;
        },
        placeholder:"导入 Excel / CSV 开始"
    });
};

// 格式化数据：去除空格并防止电话号码变成科学计数法
const normalizeData = rows => rows.map(r=>{
    for(const k in r){
        if(typeof r[k]==='string'){
            r[k]=r[k].trim();
        }
    }
    return r;
});

document.getElementById('importBtn').onclick=()=>fileInput.click();

fileInput.onchange=e=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();

    reader.onload=ev=>{
        try{
            let data=[];
            if(file.name.endsWith('.csv')){
                // 确保 PapaParse 加载成功
                if(typeof Papa === 'undefined') { toast("库文件加载中..."); return; }
                data=Papa.parse(ev.target.result,{header:true, skipEmptyLines: true}).data;
            }else{
                // 确保 XLSX 加载成功
                if(typeof XLSX === 'undefined') { toast("库文件加载中..."); return; }
                
                const dataArray = new Uint8Array(ev.target.result);
                // 修复 1：使用 cellText:true 和 raw:false 强制读取手机号文本
                const wb=XLSX.read(dataArray,{type:'array', cellText:true, raw:false});
                const sheet=wb.Sheets[wb.SheetNames[0]];
                
                // 修复 2：智能识别表头位置。针对图一的格式，range:2 表示从第 3 行开始读
                // 这里我们默认从第 3 行开始读，以适配你的“摄影社团”名单
                data=XLSX.utils.sheet_to_json(sheet,{defval:"", range: 2});
            }
            
            if(data.length === 0) {
                toast("未发现有效数据");
            } else {
                initTable(normalizeData(data));
                toast("导入成功");
            }
        }catch(err){
            console.error(err);
            toast("解析错误：" + err.message);
        }
    };

    if(file.name.endsWith('.csv')) {
        reader.readAsText(file);
    } else {
        reader.readAsArrayBuffer(file);
    }
    fileInput.value="";
};

document.getElementById('exportBtn').onclick=()=>{
    table.download("xlsx","wps_export.xlsx");
};

document.getElementById('addRowBtn').onclick=()=>table.addRow({},true);

document.getElementById('addColBtn').onclick=()=>{
    const title=prompt("请输入新列名");
    if(!title) return;
    table.addColumn({
        title,
        field:"col_"+Date.now(),
        editor:"input",
        headerFilter:"input"
    });
};

document.getElementById('vipBtn').onclick=()=>vipPanel.classList.toggle('active');
document.getElementById('closeVip').onclick=()=>vipPanel.classList.remove('active');

document.getElementById('themeBtn').onclick=()=>{
    document.documentElement.style.setProperty('--primary-color','#1a73e8');
    table.redraw();
    toast("已应用商务蓝主题");
};

document.getElementById('cleanBtn').onclick=()=>{
    table.setData(normalizeData(table.getData()));
    toast("数据已清理");
};

document.getElementById('searchInput').oninput=e=>{
    const v=e.target.value.toLowerCase();
    if(!v) return table.clearFilter();
    table.setFilter(row =>
        Object.values(row).some(val =>
            String(val).toLowerCase().includes(v)
        )
    );
};

initTable();
})();
</script>

</body>
</html>