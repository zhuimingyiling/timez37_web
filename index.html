<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§è¡¨æ ¼ç¼–è¾‘å™¨ - å¢å¼ºç‰ˆ</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary-color: #3498db; }
        body { font-family: system-ui; background: #f0f2f5; padding: 15px; margin: 0; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; max-width: 1200px; margin: auto; }
        .drop-zone { border: 2px dashed #ccc; border-radius: 10px; padding: 30px; text-align: center; color: #666; cursor: pointer; transition: 0.3s; margin-bottom: 20px; }
        .drop-zone:hover { border-color: var(--primary-color); background: #f8fbff; }
        .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; align-items: center; }
        .btn { border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-blue { background: var(--primary-color); color: white; }
        .btn-green { background: #27ae60; color: white; }
        #table-container { border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        .format-tags { font-size: 12px; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin-top:0">ğŸ“‘ é«˜çº§è¡¨æ ¼å¤„ç†ä¸­å¿ƒ</h2>
    
    <div class="drop-zone" id="dropZone">
        <strong>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶è‡³æ­¤</strong>
        <div class="format-tags">æ”¯æŒæ ¼å¼ï¼š.xlsx, .xls, .csv, .txt (Tabåˆ†éš”), .json</div>
        <input type="file" id="fileInput" hidden accept=".xlsx, .xls, .csv, .txt, .json">
    </div>

    <div class="toolbar">
        <button class="btn btn-blue" onclick="table.addRow({}, true)">â• æ–°å¢è¡Œ</button>
        <button class="btn btn-blue" onclick="addColumn()">â• æ–°å¢åˆ—</button>
        <button class="btn btn-green" onclick="exportData()">ğŸ“¥ å¯¼å‡º Excel</button>
        <button class="btn" onclick="table.undo()">â†©ï¸ æ’¤é”€</button>
        <span style="flex-grow:1"></span>
        <label style="font-size:12px">ä¸»é¢˜è‰²ï¼š<input type="color" value="#3498db" onchange="changeColor(this.value)"></label>
    </div>

    <div id="table-container"></div>
</div>

<script>
    var table;

    // æ ¸å¿ƒæ¸²æŸ“å‡½æ•°
    function renderTable(data) {
        if (table) table.destroy();
        
        table = new Tabulator("#table-container", {
            data: data,
            autoColumns: true, 
            autoColumnsDefinitions: function(definitions) {
                // è‡ªåŠ¨ä¿®å¤ï¼šè¯†åˆ«æ‰€æœ‰åˆ—å¹¶èµ‹äºˆç¼–è¾‘åŠŸèƒ½
                definitions.forEach((column) => {
                    column.editor = "input";
                    column.headerFilter = "input";
                    column.resizable = true;
                });
                return definitions;
            },
            layout: "fitColumns",
            pagination: "local",
            paginationSize: 20,
            movableColumns: true,
            history: true,
            clipboard: true, // æ”¯æŒç²˜è´´
            placeholder: "æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼ æ–‡ä»¶",
        });
    }

    // å¤šæ ¼å¼æ™ºèƒ½è¯†åˆ«å¼•æ“
    function processFile(file) {
        const reader = new FileReader();
        const extension = file.name.split('.').pop().toLowerCase();

        reader.onload = function(e) {
            let results = [];
            const data = e.target.result;

            if (['xlsx', 'xls'].includes(extension)) {
                // Excel å¢å¼ºè§£æï¼šå¤„ç†åˆå¹¶å•å…ƒæ ¼å’Œç©ºè¡Œ
                const workbook = XLSX.read(data, {type: 'binary', cellDates: true});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                results = XLSX.utils.sheet_to_json(firstSheet, {defval: ""});
            } 
            else if (extension === 'csv' || extension === 'txt') {
                // CSV/æ–‡æœ¬è§£æï¼šè‡ªåŠ¨è¯†åˆ«åˆ†éš”ç¬¦ï¼ˆé€—å·æˆ– Tabï¼‰
                Papa.parse(data, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(res) { renderTable(res.data); }
                });
                return;
            }
            else if (extension === 'json') {
                results = JSON.parse(data);
            }

            renderTable(results);
        };

        if (['xlsx', 'xls'].includes(extension)) {
            reader.readAsBinaryString(file);
        } else {
            reader.readAsText(file);
        }
    }

    // äº‹ä»¶ç»‘å®š
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => processFile(e.target.files[0]);

    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "#3498db"; };
    dropZone.ondrop = (e) => {
        e.preventDefault();
        processFile(e.dataTransfer.files[0]);
    };

    function addColumn() {
        const title = prompt("è¯·è¾“å…¥æ–°åˆ—å:");
        if (title) table.addColumn({title: title, field: title, editor: "input"});
    }

    function exportData() {
        table.download("xlsx", "å·²å¤„ç†è¡¨æ ¼.xlsx", {sheetName:"MyData"});
    }

    function changeColor(color) {
        document.documentElement.style.setProperty('--primary-color', color);
        document.querySelectorAll(".tabulator-col").forEach(c => c.style.backgroundColor = color);
    }

    // åˆå§‹ç©ºçŠ¶æ€
    renderTable([]);
</script>
</body>
</html>
