<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½è‡ªåŠ¨åŒ–æ•°æ®è¡¨</title>
    
    <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h1 { font-size: 1.4rem; color: var(--primary); margin-top: 0; display: flex; align-items: center; gap: 8px; }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-box {
            border: 2px dashed var(--primary); background: #e8f0fe;
            border-radius: 10px; padding: 40px 10px; text-align: center;
            color: var(--primary); cursor: pointer; transition: 0.3s;
        }
        .upload-box:active { background: #d2e3fc; transform: scale(0.98); }

        /* AI å¯¹è¯åŒºåŸŸ */
        .ai-section { border-top: 2px solid #eee; pt: 15px; }
        textarea { 
            width: 100%; height: 80px; padding: 12px; border: 1px solid #ddd;
            border-radius: 8px; box-sizing: border-box; font-size: 14px; margin: 10px 0;
            outline: none; transition: 0.3s;
        }
        textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(26,115,232,0.2); }

        /* æŒ‰é’®æ ·å¼ */
        .btn-group { display: flex; gap: 10px; margin: 15px 0; }
        button { 
            flex: 1; padding: 12px; border: none; border-radius: 8px; 
            background: var(--primary); color: white; font-weight: bold; cursor: pointer;
        }
        button.secondary { background: #5f6368; }
        button:disabled { background: #ccc; }

        #ai-result { 
            background: #f1f3f4; padding: 15px; border-radius: 8px; 
            font-size: 14px; line-height: 1.6; display: none; white-space: pre-wrap;
        }
        #data-table { border-radius: 10px; overflow: hidden; font-size: 13px; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ“Š è‡ªåŠ¨åŒ–æ•°æ®è¡¨</h1>
    
    <div class="upload-box" onclick="document.getElementById('file-input').click()">
        <strong>ğŸ“ ç‚¹å‡»ä¸Šä¼  Excel æˆ– CSV æ–‡ä»¶</strong>
        <p style="font-size: 12px; margin-top: 8px; opacity: 0.7;">æ”¯æŒè‡ªåŠ¨è§£æè¡¨å¤´å’Œæ•°æ®</p>
        <input type="file" id="file-input" hidden accept=".xlsx, .xls, .csv">
    </div>

    <div class="btn-group">
        <button class="secondary" onclick="clearAll()">æ¸…ç©º</button>
        <button onclick="exportCSV()">ä¸‹è½½ CSV</button>
    </div>

    <div id="data-table"></div>
</div>

<div class="card ai-section">
    <h1>ğŸ¤– AI æ•°æ®åŠ©æ‰‹</h1>
    <p style="font-size: 12px; color: #666;">ä½ å¯ä»¥é—®ï¼šåˆ†æè¿™ä»½æ•°æ®çš„è¶‹åŠ¿ã€è°çš„æ•°æ®æœ€é«˜ç­‰</p>
    
    <textarea id="ai-input" placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥ä½ çš„æŒ‡ä»¤..."></textarea>
    <button id="ai-btn" onclick="askAI()">å¼€å§‹æ™ºèƒ½åˆ†æ</button>
    
    <div id="ai-result"></div>
</div>

<script>
    var table;

    // 1. åˆå§‹åŒ–ç©ºè¡¨æ ¼
    table = new Tabulator("#data-table", {
        height: "400px",
        layout: "fitColumns",
        placeholder: "ç­‰å¾…æ•°æ®ä¸Šä¼ ...",
        autoColumns: true, // æ ¸å¿ƒï¼šè‡ªåŠ¨ç”Ÿæˆè¡¨å¤´
        pagination: "local",
        paginationSize: 10,
    });

    // 2. æ–‡ä»¶ä¸Šä¼ è§£æé€»è¾‘
    document.getElementById('file-input').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function(e) {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, {type: 'array'});
            var worksheet = workbook.Sheets[workbook.SheetNames[0]];
            var json = XLSX.utils.sheet_to_json(worksheet);
            
            if (json.length > 0) {
                table.setData(json);
            } else {
                alert("æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼");
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // 3. å¯¹æ¥ AI å¤„ç†é€»è¾‘
    async function askAI() {
        const prompt = document.getElementById('ai-input').value;
        const tableData = table.getData();
        const resultDiv = document.getElementById('ai-result');
        const btn = document.getElementById('ai-btn');

        if (!tableData.length) return alert("è¯·å…ˆä¸Šä¼ è¡¨æ ¼æ•°æ®ï¼");
        if (!prompt) return alert("è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼");

        // ç•Œé¢åé¦ˆ
        resultDiv.style.display = "block";
        resultDiv.innerText = "ğŸ¤– AI æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å...";
        btn.disabled = true;

        try {
            // è¿™é‡Œå¯¹æ¥ä½  GitHub ä»“åº“é‡Œçš„ /api/ai
            const response = await fetch('/api/ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    tableData: tableData.slice(0, 50), // ä¼ è¾“å‰50è¡Œé˜²æ­¢è¶…è¿‡AIé•¿åº¦é™åˆ¶
                    prompt: prompt 
                })
            });

            const resData = await response.json();
            // æ˜¾ç¤ºç»“æœï¼ˆå‡è®¾è¿”å›çš„æ ¼å¼æ˜¯ { response: "xxx" }ï¼‰
            resultDiv.innerText = resData.response || JSON.stringify(resData);
        } catch (error) {
            resultDiv.innerText = "âŒ AI å“åº”å¤±è´¥ã€‚è¯·æ£€æŸ¥æ˜¯å¦å·²éƒ¨ç½² /api/ai è„šæœ¬å¹¶ç»‘å®š AI èµ„æºã€‚";
            console.error(error);
        } finally {
            btn.disabled = false;
        }
    }

    // 4. åŠŸèƒ½å‡½æ•°
    function exportCSV() { table.download("csv", "data_export.csv"); }
    function clearAll() { 
        if(confirm("ç¡®å®šæ¸…ç©ºæ•°æ®ï¼Ÿ")) {
            table.clearData(); 
            document.getElementById('ai-result').style.display = "none";
        }
    }
</script>

</body>
</html>
