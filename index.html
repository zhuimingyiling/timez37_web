<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极速表格工作台</title>
    <link href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/tabulator/5.1.0/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/tabulator/5.1.0/js/tabulator.min.js"></script>
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/xlsx/0.18.2/xlsx.full.min.js"></script>
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/PapaParse/5.3.1/papaparse.min.js"></script>
    <style>
        :root { --primary-color: #3498db; --bg-color: #ffffff; --text-color: #333; --border-color: #e0e0e0; }
        [data-theme="dark"] { --bg-color: #121212; --text-color: #e0e0e0; --border-color: #333; }

        body, html { 
            height: 100%; margin: 0; padding: 0; 
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg-color); color: var(--text-color);
            overflow: hidden; 
        }

        /* 扁平化顶栏 */
        .app-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; height: 50px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-color);
        }

        .main-controls { display: flex; gap: 12px; align-items: center; }
        .logo { font-weight: bold; font-size: 16px; margin-right: 15px; color: var(--primary-color); }

        .btn { border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; transition: 0.2s; background: transparent; color: var(--text-color); border: 1px solid var(--border-color); }
        .btn-primary { background: var(--primary-color); color: white; border: none; }
        .btn:hover { opacity: 0.8; }

        /* 设置面板 */
        .settings-panel { 
            position: fixed; top: 50px; right: 0; bottom: 0; width: 240px;
            background: var(--bg-color); border-left: 1px solid var(--border-color);
            padding: 20px; display: none; z-index: 1000;
        }
        .settings-panel.active { display: block; }
        .s-item { margin-bottom: 20px; font-size: 14px; }

        /* 表格容器自适应 */
        #table-wrapper { height: calc(100vh - 50px); width: 100%; }
        .tabulator { border: none !important; }
        /* 解决字显示不全：强制换行 */
        .tabulator-cell { white-space: pre-wrap !important; word-wrap: break-word !important; border-right: 1px solid var(--border-color) !important; }
    </style>
</head>
<body data-theme="light">

    <div class="app-header">
        <div class="main-controls">
            <span class="logo">TABLE WORKFLOW</span>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">导入文件</button>
            <input type="file" id="fileInput" hidden accept=".xlsx, .xls, .csv">
            <button class="btn" onclick="table.addRow({}, true)">增行</button>
            <button class="btn" onclick="addColumn()">增列</button>
            <button class="btn" onclick="table.download('xlsx', 'data.xlsx')">导出</button>
        </div>
        <div style="cursor:pointer; font-size:18px;" onclick="toggleSettings()">⚙️</div>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <h4>偏好设置</h4>
        <div class="s-item">
            <label><input type="checkbox" onchange="toggleDarkMode(this.checked)"> 深色模式</label>
        </div>
        <div class="s-item">
            主题颜色<br>
            <input type="color" value="#3498db" style="width:100%" onchange="updateThemeColor(this.value)">
        </div>
        <div class="s-item">
            字体大小<br>
            <input type="range" min="12" max="20" value="14" style="width:100%" onchange="updateFontSize(this.value)">
        </div>
        <button class="btn" style="width:100%" onclick="toggleSettings()">完成</button>
    </div>

    <div id="table-wrapper">
        <div id="table-container"></div>
    </div>

<script>
    var table;

    // 初始化表格，开启自适应布局
    function initTable(data = []) {
        table = new Tabulator("#table-container", {
            data: data,
            layout: "fitDataFill", // 自适应内容并填满
            height: "100%",
            pagination: "local",
            paginationSize: 30,
            movableColumns: true,
            autoColumns: true,
            autoColumnsDefinitions: function(definitions) {
                definitions.forEach((col) => {
                    col.editor = "input";
                    col.formatter = "textarea"; // 自动换行防止字显示不全
                    col.headerFilter = "input";
                    col.vertAlign = "middle";
                    col.minWidth = 80;
                });
                return definitions;
            },
        });
    }

    // 极速文件读取
    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        const ext = file.name.split('.').pop().toLowerCase();

        reader.onload = (ev) => {
            try {
                let res;
                if (['xlsx', 'xls'].includes(ext)) {
                    const wb = XLSX.read(ev.target.result, {type: 'binary'});
                    res = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval: ""});
                } else {
                    Papa.parse(ev.target.result, {header: true, skipEmptyLines: true, complete: (r) => initTable(r.data)});
                    return;
                }
                initTable(res);
            } catch (err) {
                alert("文件解析失败，请检查格式");
            }
        };

        if (['xlsx', 'xls'].includes(ext)) reader.readAsBinaryString(file);
        else reader.readAsText(file);
    };

    // 交互功能
    function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('active'); }
    function toggleDarkMode(isDark) { document.body.setAttribute('data-theme', isDark ? 'dark' : 'light'); }
    function updateThemeColor(color) {
        document.documentElement.style.setProperty('--primary-color', color);
        document.querySelector(".tabulator-header").style.borderBottom = "2px solid " + color;
    }
    function updateFontSize(size) {
        document.getElementById('table-container').style.fontSize = size + "px";
        table.redraw();
    }
    function addColumn() {
        const name = prompt("新列名:");
        if(name) table.addColumn({title: name, field: name, editor: "input", formatter: "textarea"});
    }

    // 初始加载空表
    initTable([]);
</script>
</body>
</html>
