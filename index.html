<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>工作台-修复库加载版</title>
    <link href="https://cdn.staticfile.org/tabulator/5.1.0/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/tabulator/5.1.0/js/tabulator.min.js"></script>
    <script src="https://cdn.staticfile.org/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.staticfile.org/PapaParse/5.3.1/papaparse.min.js"></script>
    <style>
        :root { --primary-color: #3498db; --bg-color: #ffffff; --border-color: #e0e0e0; }
        body, html { height: 100%; margin: 0; padding: 0; font-family: system-ui, sans-serif; background: var(--bg-color); overflow: hidden; }
        .app-header { display: flex; align-items: center; justify-content: space-between; padding: 0 15px; height: 50px; border-bottom: 1px solid var(--border-color); background: var(--bg-color); }
        .btn { border: 1px solid var(--border-color); padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; background: white; }
        .btn-primary { background: var(--primary-color); color: white; border: none; }
        #table-wrapper { height: calc(100vh - 50px); width: 100%; overflow: auto; }
        .tabulator-cell { white-space: nowrap !important; border-right: 1px solid var(--border-color) !important; }
    </style>
</head>
<body>
    <div class="app-header">
        <div style="display:flex; gap:10px; align-items:center;">
            <b style="color:var(--primary-color)">WORKFLOW</b>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">导入</button>
            <input type="file" id="fileInput" hidden accept=".xlsx, .xls, .csv">
            <button class="btn" onclick="table.addRow({}, true)">增行</button>
            <button class="btn" onclick="table.download('xlsx', 'data.xlsx')">导出</button>
        </div>
        <div style="font-size:12px; color:#999;">双指缩放已启用</div>
    </div>

    <div id="table-wrapper"><div id="table-container"></div></div>

<script>
    var table;

    // 初始化表格
    function initTable(data = []) {
        table = new Tabulator("#table-container", {
            data: data,
            layout: "fitData",
            height: "100%",
            autoColumns: true,
            autoColumnsDefinitions: (defs) => {
                defs.forEach(col => { col.editor = "input"; col.headerFilter = "input"; col.minWidth = 100; });
                return defs;
            },
        });
    }

    // 处理文件
    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if(!file) return;

        // 关键：检查库是否加载
        if (typeof XLSX === 'undefined') {
            alert("正在加载解析引擎，请稍候再试...");
            location.reload(); // 如果没加载成功，强制刷新一次
            return;
        }

        const reader = new FileReader();
        const ext = file.name.split('.').pop().toLowerCase();

        reader.onload = (ev) => {
            try {
                let res;
                if (['xlsx', 'xls'].includes(ext)) {
                    const data = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    res = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval: ""});
                } else {
                    Papa.parse(ev.target.result, {header: true, skipEmptyLines: true, complete: (r) => initTable(r.data)});
                    return;
                }
                initTable(res);
            } catch (err) {
                alert("解析失败，请确保是标准Excel文件");
            }
        };

        if (['xlsx', 'xls'].includes(ext)) reader.readAsArrayBuffer(file);
        else reader.readAsText(file);
    };

    initTable([]);
</script>
</body>
</html>
